#!/bin/bash

set -e

# Check if there are changes to streams directory
if [[ -z $(git status -s src/content/streams/) ]]; then
  echo "âœ“ No changes to YouTube streams"
  exit 0
fi

# Create branch name with timestamp
BRANCH_NAME="youtube-streams-$(date +%Y%m%d-%H%M%S)"
PR_TITLE="chore: sync YouTube streams"

echo "ðŸ“ Creating branch $BRANCH_NAME"
git checkout -b "$BRANCH_NAME"

# Add only streams directory changes
git add src/content/streams/

# Commit changes
git commit -m "$PR_TITLE

Updated stream content from YouTube playlist

ðŸ¤– Automated update"

# Push branch
if ! git push origin "$BRANCH_NAME"; then
  echo "âŒ Failed to push branch"
  exit 1
fi

echo "âœ“ Branch pushed successfully"

# Get change summary for PR body
CHANGE_SUMMARY=$(git diff main --stat src/content/streams/ 2>/dev/null || echo "Changes to stream content")

# Create PR using GitHub CLI
echo "ðŸ“¬ Creating pull request"
gh pr create \
  --head "$BRANCH_NAME" \
  --title "$PR_TITLE" \
  --body "$(cat <<EOF
Automated update of YouTube stream content from playlist.

## Changes
\`\`\`
$CHANGE_SUMMARY
\`\`\`

ðŸ¤– Generated by GitHub Actions
EOF
)"

if [ $? -eq 0 ]; then
  echo "âœ… Pull request created successfully"
else
  echo "âŒ Failed to create pull request"
  exit 1
fi

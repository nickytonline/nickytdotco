---
import { getEntry, getCollection } from "astro:content";
import Layout from "../../layouts/MainLayout.astro";
import GuestCard from "../../components/GuestCard.astro";
import { dateFilter } from "../../utils/filters";

export async function getStaticPaths() {
  const guests = await getCollection("guests");

  return guests.map((guest) => ({
    params: { slug: guest.data.slug },
  }));
}

const { slug } = Astro.params;

if (!slug) {
  throw new Error("Guest not found");
}

const guest = await getEntry("guests", slug);

if (!guest) {
  throw new Error("Guest not found");
}

const { name, title, photo, social, bio } = guest.data;

// Get all streams featuring this guest
const allStreams = await getCollection("streams");
const guestStreams = allStreams
  .filter((stream) => stream.data.guest === slug)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Group streams by year
const streamsByYear = guestStreams.reduce(
  (acc, stream) => {
    const year = stream.data.date.getFullYear();
    if (!acc[year]) acc[year] = [];
    acc[year].push(stream);
    return acc;
  },
  {} as Record<number, typeof guestStreams>
);

const years = Object.keys(streamsByYear)
  .map(Number)
  .sort((a, b) => b - a);

const { Content } = await guest.render();
---

<Layout
  title={`${name} | Guest`}
  metaDesc={bio || `Guest profile for ${name}`}
  pageType="Guest"
>
  <article>
    <header class="mb-8">
      <h1
        class="text-4xl lg:text-5xl font-extrabold tracking-tight text-foreground leading-tight mb-6"
      >
        {name}
      </h1>

      <GuestCard
        name={name}
        title={title}
        photo={photo}
        slug={slug}
        social={social}
        showLink={false}
      />
    </header>

    {
      bio && (
        <div class="prose max-w-none my-8">
          <Content />
        </div>
      )
    }

    {
      guestStreams.length > 0 && (
        <section class="mt-12">
          <h2 class="text-3xl font-bold text-foreground mb-6">
            Stream Appearances ({guestStreams.length})
          </h2>

          <div class="space-y-12">
            {years.map((year) => (
              <div id={`year-${year}`}>
                <h3 class="text-2xl font-bold text-foreground mb-4 pb-2 border-b border-border">
                  {year}
                </h3>

                <ul class="space-y-4">
                  {streamsByYear[year].map((stream) => (
                    <li>
                      <a
                        href={`/videos/${stream.slug}`}
                        class="group block p-4 rounded-lg hover:bg-secondary transition-colors"
                      >
                        <h4 class="text-lg font-semibold text-foreground group-hover:text-pink-600 dark:group-hover:text-pink-400 transition-colors">
                          {stream.data.title}
                        </h4>
                        <time
                          datetime={stream.data.date.toISOString()}
                          class="text-sm text-muted-foreground mt-1 block"
                        >
                          {dateFilter(stream.data.date)}
                        </time>
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </section>
      )
    }

    {
      guestStreams.length === 0 && (
        <p class="text-muted-foreground mt-8">
          No stream appearances yet. Check back soon!
        </p>
      )
    }

    <div class="mt-12">
      <a
        href="/guests"
        class="inline-flex items-center gap-2 text-lg font-semibold text-foreground hover:text-pink-600 dark:hover:text-pink-400 transition-colors"
      >
        ‚Üê Back to all guests
      </a>
    </div>
  </article>
</Layout>

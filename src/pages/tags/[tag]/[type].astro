---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../../layouts/MainLayout.astro";
import SectionHeader from "../../../components/SectionHeader.astro";
import { dateFilter } from "../../../utils/filters";

export const prerender = true;

export async function getStaticPaths() {
  const talks = await getCollection("talks");
  const blogPosts = await getCollection("blog");
  const allTags = new Set<string>();
  const tagToOriginalCase = new Map<string, string>();

  // Collect tags from talks
  talks.forEach((talk) => {
    talk.data.tags?.forEach((tag) => {
      const normalizedTag = tag.toLowerCase().replace(/\s+/g, "");
      allTags.add(normalizedTag);
      tagToOriginalCase.set(normalizedTag, tag);
    });
  });

  // Collect tags from blog posts
  blogPosts.forEach((post) => {
    post.data.tags?.forEach((tag) => {
      const normalizedTag = tag.toLowerCase().replace(/\s+/g, "");
      allTags.add(normalizedTag);
      if (!tagToOriginalCase.has(normalizedTag)) {
        tagToOriginalCase.set(normalizedTag, tag);
      }
    });
  });

  // Create paths for each tag with both blog and talks types
  const paths: Array<{
    params: { tag: string; type: string };
    props: {
      talks: CollectionEntry<"talks">[];
      blogPosts: CollectionEntry<"blog">[];
      originalTagCase: string;
      contentType: string;
    };
  }> = [];

  Array.from(allTags).forEach((normalizedTag) => {
    const taggedTalks = talks.filter(
      (talk) =>
        talk.data.tags &&
        talk.data.tags.some(
          (tag) => tag.toLowerCase().replace(/\s+/g, "") === normalizedTag
        )
    );

    const taggedBlogPosts = blogPosts.filter(
      (post) =>
        post.data.tags &&
        post.data.tags.some(
          (tag) => tag.toLowerCase().replace(/\s+/g, "") === normalizedTag
        )
    );

    // Only create blog route if there are blog posts with this tag
    if (taggedBlogPosts.length > 0) {
      paths.push({
        params: { tag: normalizedTag, type: "blog" },
        props: {
          talks: [],
          blogPosts: taggedBlogPosts,
          originalTagCase:
            tagToOriginalCase.get(normalizedTag) || normalizedTag,
          contentType: "blog",
        },
      });
    }

    // Only create talks route if there are talks with this tag
    if (taggedTalks.length > 0) {
      paths.push({
        params: { tag: normalizedTag, type: "talks" },
        props: {
          talks: taggedTalks,
          blogPosts: [],
          originalTagCase:
            tagToOriginalCase.get(normalizedTag) || normalizedTag,
          contentType: "talks",
        },
      });
    }
  });

  return paths;
}

const { tag, type: _type } = Astro.params;
const { talks, blogPosts, originalTagCase, contentType } = Astro.props;

// Sort talks by date (newest first)
const sortedTalks =
  talks && talks.length
    ? talks.sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
    : [];

// Sort blog posts by date (newest first)
const sortedBlogPosts =
  blogPosts && blogPosts.length
    ? blogPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
    : [];

const displayTag = originalTagCase || tag;
const contentTypeLabel = contentType === "blog" ? "Blog Posts" : "Talks";
const totalCount = sortedTalks.length + sortedBlogPosts.length;
---

<Layout title={`${contentTypeLabel} tagged with "${tag}" | Nick Taylor`}>
  <main id="main" tabindex="-1" class="max-w-5xl mx-auto px-6 py-12">
    <div class="mb-12">
      <SectionHeader
        title={`${contentTypeLabel} tagged with "${displayTag}"`}
        headingLevel={1}
      />
      <p class="text-xl text-muted-foreground mt-6">
        Found {totalCount}
        {
          totalCount === 1
            ? contentType === "blog"
              ? "post"
              : "talk"
            : contentType === "blog"
              ? "posts"
              : "talks"
        } with this tag
      </p>

      <div class="mt-6 flex flex-wrap items-center gap-4">
        <a
          href={`/tags/${tag}`}
          class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-base font-semibold transition-colors bg-secondary text-secondary-foreground hover:bg-pink-600 hover:text-white focus:bg-pink-600 focus:text-white dark:hover:bg-pink-500 dark:focus:bg-pink-500 focus:outline-none"
        >
          All Content
        </a>
        <a
          href={`/tags/${tag}/blog`}
          class={`inline-flex items-center gap-2 px-4 py-2 rounded-lg text-base font-semibold transition-colors focus:outline-none ${
            contentType === "blog"
              ? "bg-pink-600 text-white dark:bg-pink-500"
              : "bg-secondary text-secondary-foreground hover:bg-pink-600 hover:text-white focus:bg-pink-600 focus:text-white dark:hover:bg-pink-500 dark:focus:bg-pink-500"
          }`}
          aria-current={contentType === "blog" ? "page" : undefined}
        >
          Blog Posts
        </a>
        <a
          href={`/tags/${tag}/talks`}
          class={`inline-flex items-center gap-2 px-4 py-2 rounded-lg text-base font-semibold transition-colors focus:outline-none ${
            contentType === "talks"
              ? "bg-pink-600 text-white dark:bg-pink-500"
              : "bg-secondary text-secondary-foreground hover:bg-pink-600 hover:text-white focus:bg-pink-600 focus:text-white dark:hover:bg-pink-500 dark:focus:bg-pink-500"
          }`}
          aria-current={contentType === "talks" ? "page" : undefined}
        >
          Talks
        </a>
      </div>

      <div class="mt-6">
        <a
          href="/tags"
          class="inline-flex items-center gap-2 text-lg font-semibold text-foreground hover:text-pink-600 dark:hover:text-pink-400"
        >
          View all tags<span class="text-2xl">→</span>
        </a>
      </div>
    </div>

    <div class="space-y-12">
      {
        sortedBlogPosts.length > 0 && (
          <section>
            <div class="space-y-1">
              {sortedBlogPosts.map((post) => {
                const slug = post.slug;
                const readTime = post.data.reading_time_minutes
                  ? `${post.data.reading_time_minutes} min read`
                  : null;
                return (
                  <div class="py-5 px-6">
                    <div class="flex items-baseline justify-between gap-6">
                      <div class="flex-1">
                        <h2 class="text-xl font-bold">
                          <a
                            href={`/blog/${slug}`}
                            class="text-foreground hover:text-pink-600 hover:underline focus:text-pink-600 focus:underline dark:hover:text-pink-400 dark:focus:text-pink-400 focus:outline-none"
                          >
                            {post.data.title}
                          </a>
                        </h2>
                        <div class="flex items-center gap-4 text-muted-foreground mt-2">
                          <span class="italic text-base">
                            {dateFilter(post.data.date)}
                          </span>
                          {readTime && (
                            <>
                              <span class="text-pink-600 dark:text-pink-400 font-semibold">
                                •
                              </span>
                              <span class="text-base font-semibold text-pink-600 dark:text-pink-400">
                                {readTime}
                              </span>
                            </>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </section>
        )
      }

      {
        sortedTalks.length > 0 && (
          <section>
            <div class="space-y-1">
              {sortedTalks.map((talk) => {
                const slug = talk.slug;
                return (
                  <div class="py-5 px-6">
                    <div class="flex items-baseline justify-between gap-6">
                      <div class="flex-1">
                        <h2 class="text-xl font-bold">
                          <a
                            href={`/talks/${slug}`}
                            class="text-foreground hover:text-pink-600 hover:underline focus:text-pink-600 focus:underline dark:hover:text-pink-400 dark:focus:text-pink-400 focus:outline-none"
                          >
                            {talk.data.title}
                          </a>
                        </h2>
                        <div class="flex items-center gap-4 text-muted-foreground mt-2">
                          <span class="italic text-base">
                            {dateFilter(talk.data.date)}
                          </span>
                          <span class="text-pink-600 dark:text-pink-400 font-semibold">
                            •
                          </span>
                          <span class="text-base font-semibold text-pink-600 dark:text-pink-400">
                            {talk.data.venue.name}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </section>
        )
      }

      {
        totalCount === 0 && (
          <div class="text-center py-12">
            <p class="text-xl text-muted-foreground">
              No content found with this tag.
            </p>
          </div>
        )
      }
    </div>
  </main>
</Layout>

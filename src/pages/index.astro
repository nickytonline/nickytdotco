---
import StreamSchedule from "../components/StreamSchedule.astro";
import SectionHeader from "../components/SectionHeader.astro";
import BlogPostCard from "../components/BlogPostCard.astro";
import Layout from "../layouts/MainLayout.astro";
import type { StreamGuestInfo } from "../utils/schedule-utils";
import { getLiveCollection } from "astro:content";
import { getCollection } from "astro:content";
import { site } from "../data/site";
import { dateFilter } from "../utils/filters";

const allPosts = await getCollection("blog", ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});

// Sort by date descending
const sortedPosts = allPosts.sort((a, b) => {
  return b.data.date.getTime() - a.data.date.getTime();
});

const recentPosts = sortedPosts.slice(0, site.maxPostsPerPage);

const locale =
  Astro.request.headers.get("Accept-Language")?.split(",")[0] ||
  Astro.request.headers.get("Accept-Language") ||
  "en-US";

let errorMessage = "";
let schedule: StreamGuestInfo[] = [];

const scheduleResult = await getLiveCollection("streamSchedule");

if (scheduleResult.error) {
  console.error("Error fetching stream schedule:", scheduleResult.error);
  errorMessage = "Error fetching stream schedule.";
} else {
  schedule = scheduleResult.entries?.map((entry) => entry.data) ?? [];
}

const { timezone = "" } = Astro.locals.netlify.context.geo;

if (!errorMessage) {
  Astro.response.headers.set(
    "Cache-Control",
    "public, max-age=0, must-revalidate"
  );
  Astro.response.headers.set(
    "Netlify-CDN-Cache-Control",
    "public, max-age=259200, must-revalidate"
  );
  Astro.response.headers.set("timezone", timezone);
  Astro.response.headers.set("Netlify-Vary", "header=Accept-Language|timezone");
}

export const prerender = false;
---

<Layout title="Welcome to Nick Taylor's website">
  <div class="space-y-12">
    <SectionHeader title="Latest Content" headingLevel={1} />
    <section class="grid gap-6 xl:gap-8">
      <h2>Blog Posts</h2>
      {
        recentPosts.map((post) => (
          <BlogPostCard
            title={post.data.title}
            date={dateFilter(post.data.date)}
            image={post.data.cover_image}
            href={`/blog/${post.slug}`}
          />
        ))
      }
      <a
        href="/blog"
        class="mt-4 inline-flex items-center gap-2 text-lg font-semibold text-black dark:text-white hover:text-pink-600"
      >
        More blog posts<span class="text-2xl">â†’</span>
      </a>
    </section>

    <section class="grid gap-6 xl:gap-8">
      {
        errorMessage ? (
          <>
            <h2>Upcoming Live Streams</h2>
            <p class="text-red-600">{errorMessage}</p>
          </>
        ) : null
      }
      {
        !errorMessage && schedule.length > 0 ? (
          <>
            <h2>Upcoming Live Streams</h2>
            <StreamSchedule
              schedule={schedule}
              locale={locale}
              timezone={timezone}
            />
          </>
        ) : null
      }
    </section>
  </div>
</Layout>

---
import { getLiveCollection } from "astro:content";
import Layout from "../layouts/MainLayout.astro";
import SectionHeader from "../components/SectionHeader.astro";
import { dateFilter } from "../utils/filters";

const newsletterResult = await getLiveCollection("newsletter");

if (newsletterResult.error) {
  console.error("Error fetching newsletter:", newsletterResult.error);
  throw new Error("Failed to fetch newsletter");
}

const newsletter =
  newsletterResult.entries?.map((entry) => entry.data).filter(Boolean) ?? [];

const sortedPosts = [...newsletter].sort((a, b) => {
  const dateA = new Date(a.date);
  const dateB = new Date(b.date);
  return dateB.getTime() - dateA.getTime();
});

const SUBSCRIBE_URL =
  "https://OneTipAWeek.com?utm_source=nickytco&utm_medium=social";

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=0, must-revalidate"
);
Astro.response.headers.set(
  "Netlify-CDN-Cache-Control",
  "public, max-age=259200, must-revalidate"
);

export const prerender = false;
---

<Layout
  title="Newsletter | Nick Taylor"
  socialImage="/assets/images/page-og/newsletter.jpg"
>
  <div class="mb-6">
    <SectionHeader title="Newsletter" headingLevel={1} />
    <p class="text-xl text-muted-foreground mt-6">
      One developer tip a week. Short & valuable. That's it!.
    </p>
    <div class="mt-6">
      <a
        href={SUBSCRIBE_URL}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 px-5 py-2.5 text-base font-semibold text-white bg-pink-600 hover:bg-pink-700 dark:bg-pink-500 dark:hover:bg-pink-600 rounded-lg transition-colors focus:bg-pink-700 dark:focus:bg-pink-600 focus:outline-none"
      >
        Subscribe to Newsletter<span class="text-xl">â†’</span>
      </a>
    </div>
  </div>

  <ul class="grid gap-4 lg:gap-8 mt-12">
    {
      sortedPosts.map((post) => {
        const postDate = new Date(post.date);
        return (
          <li>
            <h2 class="text-xl font-bold">
              <a
                href={post.link}
                target="_blank"
                rel="noopener noreferrer"
                class="text-foreground hover:text-pink-600 hover:underline focus:text-pink-600 focus:underline dark:hover:text-pink-400 dark:focus:text-pink-400 focus:outline-none"
              >
                {post.title}
              </a>
            </h2>
            <div class="flex items-center gap-4 text-muted-foreground mt-2">
              <span class="italic text-base">{dateFilter(postDate)}</span>
            </div>
          </li>
        );
      })
    }
  </ul>
</Layout>

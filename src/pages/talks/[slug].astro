---
import { getEntry, getCollection } from "astro:content";
import Layout from "../../layouts/MainLayout.astro";
import TagList from "../../components/TagList.astro";
import { getRelatedTalks } from "../../utils/tag-utils";
import { getYouTubeId } from "../../utils/youtube-utils";
import { dateFilter } from "../../utils/filters";
import YouTubeEmbed from "../../components/embeds/YouTubeEmbed.astro";
export const prerender = true;

export async function getStaticPaths() {
  const talks = await getCollection("talks");

  return talks.map((talk) => ({
    params: { slug: talk.slug },
  }));
}

const { slug } = Astro.params;

if (!slug) {
  throw new Error("Talk not found");
}

const talk = await getEntry("talks", slug);

if (!talk) {
  throw new Error("Talk not found");
}

// Get all talks to find related ones
const allTalks = await getCollection("talks");
const relatedTalks = getRelatedTalks(talk, allTalks, 3);

const {
  title,
  date,
  venue,
  tags = [],
  video,
  slideDeck,
  sourceCode,
  additionalLinks = [],
} = talk.data;

const { Content } = await talk.render();
---

<Layout
  title={`${title} | Nick Taylor's Talks`}
  socialImage="/assets/images/page-og/talks.jpg"
  pageType="Talk"
>
  <article>
    <header>
      <h1
        class="text-4xl lg:text-5xl font-extrabold tracking-tight text-foreground leading-tight"
        data-pagefind-meta="title"
      >
        {title}
      </h1>
      <div
        class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 text-lg text-muted-foreground"
      >
        {
          venue.url ? (
            <a
              href={venue.url}
              target="_blank"
              rel="noopener noreferrer"
              class="font-semibold text-pink-600 dark:text-pink-400 hover:underline focus:underline focus:outline-none"
            >
              {venue.name}
            </a>
          ) : (
            <span class="font-semibold text-pink-600 dark:text-pink-400">
              {venue.name}
            </span>
          )
        }
        <span
          class="hidden sm:inline text-pink-600 dark:text-pink-400 font-semibold"
          >•</span
        >
        <time datetime={date.toISOString()} class="italic">
          {dateFilter(date)}
        </time>
      </div>
    </header>

    {
      video ? (
        <div class="my-6">
          {video.type === "youtube" && (
            <YouTubeEmbed
              videoId={getYouTubeId(video.url) || ""}
              title={title}
            />
          )}
          {video.type === "vimeo" && (
            <div class="relative w-full aspect-video rounded-xl overflow-hidden border-2 border-border shadow-lg">
              <iframe
                src={video.url.replace("vimeo.com/", "player.vimeo.com/video/")}
                allow="autoplay; fullscreen; picture-in-picture"
                allowfullscreen
                class="absolute inset-0 w-full h-full"
                title="Vimeo video player"
              />
            </div>
          )}
          {video.type === "custom" && video.image && (
            <a
              href={video.url}
              target="_blank"
              rel="noopener noreferrer"
              class="block hover:opacity-90 transition-opacity"
            >
              <img
                src={video.image.url}
                width={video.image.width}
                height={video.image.height}
                alt="Talk video preview"
                class="rounded-xl border-2 border-border shadow-lg w-full"
              />
            </a>
          )}
        </div>
      ) : (
        <p class="my-6 text-muted-foreground italic">
          This talk was not recorded.
        </p>
      )
    }

    <div class="prose max-w-none">
      <Content />
    </div>

    {
      (slideDeck || sourceCode || additionalLinks.length > 0) && (
        <div class="flex flex-wrap gap-3">
          {slideDeck && (
            <a
              href={slideDeck}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 px-5 py-2.5 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 focus:bg-pink-700 focus:outline-none transition-colors"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              View Slides
            </a>
          )}
          {sourceCode && (
            <a
              href={sourceCode}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 px-5 py-2.5 bg-foreground text-background font-semibold rounded-lg hover:opacity-90 focus:opacity-90 focus:outline-none transition-opacity"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
              </svg>
              Source Code
            </a>
          )}
          {additionalLinks.map((link: { title: string; url: string }) => (
            <a
              href={link.url}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 px-5 py-2.5 border-2 border-pink-600 dark:border-pink-400 text-pink-600 dark:text-pink-400 font-semibold rounded-lg hover:bg-pink-600 hover:text-white dark:hover:bg-pink-500 focus:bg-pink-600 focus:text-white dark:focus:bg-pink-500 focus:outline-none transition-colors"
            >
              {link.title}
            </a>
          ))}
        </div>
      )
    }

    {
      tags && tags.length > 0 && (
        <footer class="pt-8">
          <div class="flex items-center gap-3 flex-wrap">
            <h2 class="text-xl font-semibold text-foreground">Tags:</h2>
            <div class="flex flex-wrap gap-2">
              <TagList tags={tags} />
            </div>
          </div>
        </footer>
      )
    }

    {
      relatedTalks.length > 0 && (
        <section class="pt-8" data-pagefind-ignore>
          <h2 class="text-2xl font-bold mb-6 text-foreground">Related Talks</h2>
          <div class="grid gap-6 xl:gap-8">
            {relatedTalks.map((relatedTalk) => {
              const relatedSlug = relatedTalk.slug;
              return (
                <a
                  href={`/talks/${relatedSlug}`}
                  class="group grid gap-6 xl:gap-8 no-underline outline-none transition-colors"
                >
                  <div class="flex-1 flex flex-col justify-center gap-2 min-w-0">
                    <h3 class="text-xl font-semibold leading-snug text-card-foreground group-hover:text-pink-600 group-hover:underline group-focus:text-pink-600 group-focus:underline dark:group-hover:text-pink-400 dark:group-focus:text-pink-400">
                      {relatedTalk.data.title}
                    </h3>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 text-base text-muted-foreground">
                      <span class="font-normal">
                        {relatedTalk.data.venue.name}
                      </span>
                      <span class="hidden sm:inline text-pink-600 dark:text-pink-400 font-semibold">
                        •
                      </span>
                      <time
                        datetime={relatedTalk.data.date.toISOString()}
                        class="italic font-normal"
                      >
                        {dateFilter(relatedTalk.data.date)}
                      </time>
                    </div>
                  </div>
                </a>
              );
            })}
          </div>
        </section>
      )
    }
  </article>
</Layout>

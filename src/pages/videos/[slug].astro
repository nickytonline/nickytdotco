---
import { getEntry, getCollection } from "astro:content";
import Layout from "../../layouts/MainLayout.astro";
import { dateFilter } from "../../utils/filters";
import YouTubeEmbed from "../../components/embeds/YouTubeEmbed.astro";
import GuestCard from "../../components/GuestCard.astro";

export async function getStaticPaths() {
  const streams = await getCollection("streams");

  return streams.map((stream) => ({
    params: { slug: stream.slug },
  }));
}

const { slug } = Astro.params;

if (!slug) {
  throw new Error("Stream not found");
}

const stream = await getEntry("streams", slug);

if (!stream) {
  throw new Error("Stream not found");
}

const { title, date, videoId, guest: guestSlug } = stream.data;

// Fetch guest information if available
let guestData = null;
if (guestSlug) {
  const guestEntry = await getEntry("guests", guestSlug);
  if (guestEntry) {
    guestData = guestEntry.data;
  }
}

const { Content } = await stream.render();
---

<Layout
  title={`${title} | Nick Taylor's Streams`}
  socialImage="/assets/images/page-og/watch.jpg"
  pageType="Stream"
>
  <article>
    <header>
      <h1
        class="text-4xl lg:text-5xl font-extrabold tracking-tight text-foreground leading-tight"
        data-pagefind-meta="title"
      >
        {title}
      </h1>
      <div class="text-lg text-muted-foreground">
        <time datetime={date.toISOString()} class="italic">
          {dateFilter(date)}
        </time>
      </div>
    </header>

    <div class="my-6">
      <YouTubeEmbed videoId={videoId} title={title} />
    </div>

    {
      guestData && (
        <div class="my-8">
          <h2 class="text-2xl font-bold text-foreground mb-4">Featured Guest</h2>
          <GuestCard
            name={guestData.name}
            title={guestData.title}
            photo={guestData.photo}
            slug={guestData.slug}
            social={guestData.social}
            showLink={true}
          />
        </div>
      )
    }

    <div class="mb-6">
      <a
        href="/videos"
        class="inline-flex items-center gap-2 text-lg font-semibold text-foreground hover:text-pink-600 dark:hover:text-pink-400"
      >
        Back to video archives<span class="text-2xl">â†’</span>
      </a>
    </div>

    <div class="prose max-w-none" data-pagefind-body>
      <Content />
    </div>
  </article>
</Layout>

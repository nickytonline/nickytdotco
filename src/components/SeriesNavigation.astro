---
import { getCollection, type CollectionEntry } from "astro:content";
import { seriesFilter, seriesName, truncate } from "../utils/filters";
import slugify from "slugify";

export interface Props {
  series?: {
    name: string;
    collection_id: number;
  };
  currentUrl: string;
}

const { series, currentUrl } = Astro.props;

if (!series) {
  return null;
}

// Get all blog posts
const allPosts = await getCollection("blog");

// Filter by series and sort by date
const seriesPosts = seriesFilter(allPosts, series) as CollectionEntry<"blog">[];
const sortedPosts = seriesPosts.sort(
  (a, b) => a.data.date.getTime() - b.data.date.getTime()
);

if (sortedPosts.length <= 1) {
  return null;
}

// Find current post index
const currentIndex = sortedPosts.findIndex(
  (post) => `/blog/${post.slug}` === currentUrl
);
const totalPosts = sortedPosts.length;
const hasCollapse = totalPosts > 5;

// Position helpers
const isFirst = currentIndex === 0;
const isSecond = currentIndex === 1;
const isSecondToLast = currentIndex === totalPosts - 2;
const isLast = currentIndex === totalPosts - 1;

// Helper function to determine if an item should be shown
function shouldShowItem(index: number): boolean {
  if (!hasCollapse) return true;

  if (isFirst || isSecond) {
    return (
      index === 0 || index === 1 || index === 2 || index === totalPosts - 1
    );
  } else if (isSecondToLast || isLast) {
    return (
      index === 0 ||
      index === totalPosts - 3 ||
      index === totalPosts - 2 ||
      index === totalPosts - 1
    );
  } else {
    return index === 0 || index === currentIndex || index === totalPosts - 1;
  }
}

const seriesSlug = slugify(seriesName(series), { lower: true, strict: true });
---

<aside
  class="my-900 rounded-xl border border-(--color-stroke) bg-(--color-bg) p-700"
>
  <nav aria-label="Series navigation" role="navigation">
    <h2 class="mb-700 text-600 font-bold text-(--color-theme-primary)">
      {seriesName(series)}
    </h2>

    <ol
      id={`series-list-${seriesSlug}`}
      class="m-0 flex list-none flex-col gap-500 p-0"
      role="list"
      data-series-list
    >
      {
        sortedPosts.map((post, i) => {
          const isCurrent = i === currentIndex;
          const shouldShow = shouldShowItem(i);

          // Determine ellipsis positions
          let showEllipsisBefore = false;
          let showEllipsisAfter = false;

          if (hasCollapse) {
            if ((isSecondToLast || isLast) && i === 1) {
              showEllipsisBefore = true;
            } else if (
              !isFirst &&
              !isSecond &&
              !isSecondToLast &&
              !isLast &&
              i === 1
            ) {
              showEllipsisBefore = true;
            }

            if ((isFirst || isSecond) && i === 3) {
              showEllipsisAfter = true;
            } else if (
              !isFirst &&
              !isSecond &&
              !isSecondToLast &&
              !isLast &&
              i === currentIndex + 1
            ) {
              showEllipsisAfter = true;
            }
          }

          return (
            <>
              {showEllipsisBefore && (
                <>
                  {(() => {
                    let hiddenCount = 0;
                    let hiddenStart = 1;
                    let hiddenEnd = currentIndex;

                    if (isSecondToLast || isLast) {
                      hiddenCount = totalPosts - 4;
                      hiddenEnd = totalPosts - 3;
                    } else {
                      hiddenCount = currentIndex - 1;
                    }

                    if (hiddenCount === 1) {
                      const hiddenPost =
                        sortedPosts[
                          isSecondToLast || isLast ? 1 : currentIndex - 1
                        ];
                      const hiddenIndex =
                        isSecondToLast || isLast ? 1 : currentIndex - 1;
                      return (
                        <li class="flex items-start gap-500" role="listitem">
                          <span
                            class="flex h-700 w-700 shrink-0 items-center justify-center rounded-full bg-(--color-stroke) text-300 font-semibold leading-none text-(--color-text)"
                            aria-hidden="true"
                          >
                            {hiddenIndex + 1}
                          </span>
                          <div class="min-w-0 flex-1 pt-100">
                            <a
                              href={`/blog/${hiddenPost.slug}`}
                              class="block wrap-break-word leading-mid text-(--color-text) no-underline hover:text-(--color-theme-primary) hover:underline focus-visible:rounded-[2px] focus-visible:text-(--color-theme-primary) focus-visible:underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-(--color-theme-primary) focus-visible:outline-offset-2"
                            >
                              {truncate(hiddenPost.data.title, 80)}
                            </a>
                          </div>
                        </li>
                      );
                    } else {
                      return (
                        <>
                          <li class="flex items-center gap-500" role="listitem">
                            <span
                              class="grid h-700 w-700 shrink-0 place-items-center rounded-full bg-transparent p-0 text-500 tracking-[-0.05em] text-(--color-text-muted,#6b7280)"
                              aria-hidden="true"
                            >
                              ···
                            </span>
                            <button
                              type="button"
                              class="cursor-pointer border-0 bg-transparent p-0 text-left text-300 font-medium text-(--color-theme-primary) hover:underline focus-visible:rounded-[2px] focus-visible:underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-(--color-theme-primary) focus-visible:outline-offset-2"
                              aria-expanded="false"
                              data-series-toggle="before"
                            >
                              {hiddenCount} more parts…
                            </button>
                          </li>
                          {seriesPosts
                            .slice(hiddenStart, hiddenEnd)
                            .map((hiddenPost, hiddenIdx) => (
                              <li
                                class="hidden flex items-start gap-500"
                                data-series-section="before"
                                role="listitem"
                              >
                                <span
                                  class="flex h-700 w-700 shrink-0 items-center justify-center rounded-full bg-(--color-stroke) text-300 font-semibold leading-none text-(--color-text)"
                                  aria-hidden="true"
                                >
                                  {hiddenStart + hiddenIdx + 1}
                                </span>
                                <div class="min-w-0 flex-1 pt-100">
                                  <a
                                    href={`/blog/${hiddenPost.slug}`}
                                    class="block wrap-break-word leading-mid text-(--color-text) no-underline hover:text-(--color-theme-primary) hover:underline focus-visible:rounded-[2px] focus-visible:text-(--color-theme-primary) focus-visible:underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-(--color-theme-primary) focus-visible:outline-offset-2"
                                  >
                                    {truncate(hiddenPost.data.title, 80)}
                                  </a>
                                </div>
                              </li>
                            ))}
                        </>
                      );
                    }
                  })()}
                </>
              )}

              {shouldShow && (
                <li class="flex items-start gap-500" role="listitem">
                  <span
                    class:list={[
                      "flex h-700 w-700 shrink-0 items-center justify-center rounded-full text-300 font-semibold leading-none",
                      isCurrent
                        ? "bg-(--color-theme-primary) text-white"
                        : "bg-(--color-stroke) text-(--color-text)",
                    ]}
                    aria-hidden="true"
                  >
                    {i + 1}
                  </span>
                  <div class="min-w-0 flex-1 pt-100">
                    {isCurrent ? (
                      <>
                        <span class="block wrap-break-word leading-mid font-semibold text-(--color-theme-primary)">
                          {post.data.title}
                        </span>
                        <span class="sr-only">(current post)</span>
                      </>
                    ) : (
                      <a
                        href={`/blog/${post.slug}`}
                        class="block wrap-break-word leading-mid text-(--color-text) no-underline hover:text-(--color-theme-primary) hover:underline focus-visible:rounded-[2px] focus-visible:text-(--color-theme-primary) focus-visible:underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-(--color-theme-primary) focus-visible:outline-offset-2"
                      >
                        {truncate(post.data.title, 80)}
                      </a>
                    )}
                  </div>
                </li>
              )}

              {showEllipsisAfter && (
                <>
                  {(() => {
                    let hiddenCount = 0;
                    let hiddenStart = currentIndex + 1;
                    let hiddenEnd = totalPosts - 1;

                    if (isFirst || isSecond) {
                      hiddenCount = totalPosts - 4;
                      hiddenStart = 3;
                    } else {
                      hiddenCount = totalPosts - currentIndex - 2;
                    }

                    if (hiddenCount === 1) {
                      const hiddenPost =
                        sortedPosts[isFirst || isSecond ? 3 : currentIndex + 1];
                      const hiddenIndex =
                        isFirst || isSecond ? 3 : currentIndex + 1;
                      return (
                        <li class="flex items-start gap-500" role="listitem">
                          <span
                            class="flex h-700 w-700 shrink-0 items-center justify-center rounded-full bg-(--color-stroke) text-300 font-semibold leading-none text-(--color-text)"
                            aria-hidden="true"
                          >
                            {hiddenIndex + 1}
                          </span>
                          <div class="min-w-0 flex-1 pt-100">
                            <a
                              href={`/blog/${hiddenPost.slug}`}
                              class="block wrap-break-word leading-mid text-(--color-text) no-underline hover:text-(--color-theme-primary) hover:underline focus-visible:rounded-[2px] focus-visible:text-(--color-theme-primary) focus-visible:underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-(--color-theme-primary) focus-visible:outline-offset-2"
                            >
                              {truncate(hiddenPost.data.title, 80)}
                            </a>
                          </div>
                        </li>
                      );
                    } else {
                      return (
                        <>
                          <li class="flex items-center gap-500" role="listitem">
                            <span
                              class="grid h-700 w-700 shrink-0 place-items-center rounded-full bg-transparent p-0 text-500 tracking-[-0.05em] text-(--color-text-muted,#6b7280)"
                              aria-hidden="true"
                            >
                              ···
                            </span>
                            <button
                              type="button"
                              class="cursor-pointer border-0 bg-transparent p-0 text-left text-300 font-medium text-(--color-theme-primary) hover:underline focus-visible:rounded-[2px] focus-visible:underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-(--color-theme-primary) focus-visible:outline-offset-2"
                              aria-expanded="false"
                              data-series-toggle="after"
                            >
                              {hiddenCount} more parts…
                            </button>
                          </li>
                          {seriesPosts
                            .slice(hiddenStart, hiddenEnd)
                            .map((hiddenPost, hiddenIdx) => (
                              <li
                                class="hidden flex items-start gap-500"
                                data-series-section="after"
                                role="listitem"
                              >
                                <span
                                  class="flex h-700 w-700 shrink-0 items-center justify-center rounded-full bg-(--color-stroke) text-300 font-semibold leading-none text-(--color-text)"
                                  aria-hidden="true"
                                >
                                  {hiddenStart + hiddenIdx + 1}
                                </span>
                                <div class="min-w-0 flex-1 pt-100">
                                  <a
                                    href={`/blog/${hiddenPost.slug}`}
                                    class="block wrap-break-word leading-mid text-(--color-text) no-underline hover:text-(--color-theme-primary) hover:underline focus-visible:rounded-[2px] focus-visible:text-(--color-theme-primary) focus-visible:underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-(--color-theme-primary) focus-visible:outline-offset-2"
                                  >
                                    {truncate(hiddenPost.data.title, 80)}
                                  </a>
                                </div>
                              </li>
                            ))}
                        </>
                      );
                    }
                  })()}
                </>
              )}
            </>
          );
        })
      }
    </ol>
  </nav>
</aside>

<script>
  (function () {
    document.addEventListener("click", function (e) {
      const btn = (e.target as HTMLElement).closest(
        "[data-series-toggle]"
      ) as HTMLButtonElement;
      if (!btn) return;

      const section = btn.getAttribute("data-series-toggle");
      const list = btn.closest("[data-series-list]");
      if (!list) return;

      // Find all items in this section
      const selector = section
        ? `[data-series-section="${section}"]`
        : ".hidden";
      const hiddenItems = list.querySelectorAll(selector);

      // Toggle visibility
      const isExpanded = btn.getAttribute("aria-expanded") === "true";
      const newState = !isExpanded;

      hiddenItems.forEach(function (item) {
        if (newState) {
          item.classList.remove("hidden");
        } else {
          item.classList.add("hidden");
        }
      });

      btn.setAttribute("aria-expanded", newState ? "true" : "false");

      // Update button text
      const count = hiddenItems.length;
      const originalText = count + " more parts…";
      const collapsedText = "Show less";
      btn.textContent = newState ? collapsedText : originalText;
    });
  })();
</script>

---
import { getCollection } from 'astro:content';
import { seriesFilter, seriesName, truncate } from '../utils/filters';
import slugify from 'slugify';

export interface Props {
  series?: {
    name: string;
    collection_id: number;
  };
  currentUrl: string;
}

const { series, currentUrl } = Astro.props;

if (!series) {
  return null;
}

// Get all blog posts
const allPosts = await getCollection('blog');

// Filter by series and sort by date
const seriesPosts = seriesFilter(allPosts, series).sort((a, b) =>
  a.data.date.getTime() - b.data.date.getTime()
);

if (seriesPosts.length <= 1) {
  return null;
}

// Find current post index
const currentIndex = seriesPosts.findIndex(post => `/blog/${post.slug}` === currentUrl);
const totalPosts = seriesPosts.length;
const hasCollapse = totalPosts > 5;

// Position helpers
const isFirst = currentIndex === 0;
const isSecond = currentIndex === 1;
const isSecondToLast = currentIndex === totalPosts - 2;
const isLast = currentIndex === totalPosts - 1;

// Helper function to determine if an item should be shown
function shouldShowItem(index: number): boolean {
  if (!hasCollapse) return true;

  if (isFirst || isSecond) {
    return index === 0 || index === 1 || index === 2 || index === totalPosts - 1;
  } else if (isSecondToLast || isLast) {
    return index === 0 || index === totalPosts - 3 || index === totalPosts - 2 || index === totalPosts - 1;
  } else {
    return index === 0 || index === currentIndex || index === totalPosts - 1;
  }
}

const seriesSlug = slugify(seriesName(series), { lower: true, strict: true });
---

<aside class="series-navigation">
  <nav aria-label="Series navigation" role="navigation">
    <h2>{seriesName(series)}</h2>

    <ol
      id={`series-list-${seriesSlug}`}
      class="series-list"
      role="list"
      data-series-list
    >
      {seriesPosts.map((post, i) => {
        const isCurrent = i === currentIndex;
        const shouldShow = shouldShowItem(i);

        // Determine ellipsis positions
        let showEllipsisBefore = false;
        let showEllipsisAfter = false;

        if (hasCollapse) {
          if ((isSecondToLast || isLast) && i === 1) {
            showEllipsisBefore = true;
          } else if (!isFirst && !isSecond && !isSecondToLast && !isLast && i === 1) {
            showEllipsisBefore = true;
          }

          if ((isFirst || isSecond) && i === 3) {
            showEllipsisAfter = true;
          } else if (!isFirst && !isSecond && !isSecondToLast && !isLast && i === currentIndex + 1) {
            showEllipsisAfter = true;
          }
        }

        return (
          <>
            {showEllipsisBefore && (
              <>
                {(() => {
                  let hiddenCount = 0;
                  let hiddenStart = 1;
                  let hiddenEnd = currentIndex;

                  if (isSecondToLast || isLast) {
                    hiddenCount = totalPosts - 4;
                    hiddenEnd = totalPosts - 3;
                  } else {
                    hiddenCount = currentIndex - 1;
                  }

                  if (hiddenCount === 1) {
                    const hiddenPost = seriesPosts[isSecondToLast || isLast ? 1 : currentIndex - 1];
                    const hiddenIndex = isSecondToLast || isLast ? 1 : currentIndex - 1;
                    return (
                      <li class="series-item" role="listitem">
                        <span class="series-badge" aria-hidden="true">{hiddenIndex + 1}</span>
                        <div class="series-content">
                          <a href={`/blog/${hiddenPost.slug}`} class="series-title series-title--link">
                            {truncate(hiddenPost.data.title, 80)}
                          </a>
                        </div>
                      </li>
                    );
                  } else {
                    return (
                      <>
                        <li class="series-item series-item--toggle" role="listitem">
                          <span class="series-badge series-badge--collapsed" aria-hidden="true">···</span>
                          <button type="button" class="series-toggle" aria-expanded="false" data-series-toggle="before">
                            {hiddenCount} more parts…
                          </button>
                        </li>
                        {seriesPosts.slice(hiddenStart, hiddenEnd).map((hiddenPost, hiddenIdx) => (
                          <li class="series-item series-item--hidden" data-series-section="before" role="listitem">
                            <span class="series-badge" aria-hidden="true">{hiddenStart + hiddenIdx + 1}</span>
                            <div class="series-content">
                              <a href={`/blog/${hiddenPost.slug}`} class="series-title series-title--link">
                                {truncate(hiddenPost.data.title, 80)}
                              </a>
                            </div>
                          </li>
                        ))}
                      </>
                    );
                  }
                })()}
              </>
            )}

            {shouldShow && (
              <li class:list={["series-item", { "series-item--current": isCurrent }]} role="listitem">
                <span class:list={["series-badge", { "series-badge--current": isCurrent }]} aria-hidden="true">
                  {i + 1}
                </span>
                <div class="series-content">
                  {isCurrent ? (
                    <>
                      <span class="series-title series-title--current">{post.data.title}</span>
                      <span class="sr-only">(current post)</span>
                    </>
                  ) : (
                    <a href={`/blog/${post.slug}`} class="series-title series-title--link">
                      {truncate(post.data.title, 80)}
                    </a>
                  )}
                </div>
              </li>
            )}

            {showEllipsisAfter && (
              <>
                {(() => {
                  let hiddenCount = 0;
                  let hiddenStart = currentIndex + 1;
                  let hiddenEnd = totalPosts - 1;

                  if (isFirst || isSecond) {
                    hiddenCount = totalPosts - 4;
                    hiddenStart = 3;
                  } else {
                    hiddenCount = totalPosts - currentIndex - 2;
                  }

                  if (hiddenCount === 1) {
                    const hiddenPost = seriesPosts[isFirst || isSecond ? 3 : currentIndex + 1];
                    const hiddenIndex = isFirst || isSecond ? 3 : currentIndex + 1;
                    return (
                      <li class="series-item" role="listitem">
                        <span class="series-badge" aria-hidden="true">{hiddenIndex + 1}</span>
                        <div class="series-content">
                          <a href={`/blog/${hiddenPost.slug}`} class="series-title series-title--link">
                            {truncate(hiddenPost.data.title, 80)}
                          </a>
                        </div>
                      </li>
                    );
                  } else {
                    return (
                      <>
                        <li class="series-item series-item--toggle" role="listitem">
                          <span class="series-badge series-badge--collapsed" aria-hidden="true">···</span>
                          <button type="button" class="series-toggle" aria-expanded="false" data-series-toggle="after">
                            {hiddenCount} more parts…
                          </button>
                        </li>
                        {seriesPosts.slice(hiddenStart, hiddenEnd).map((hiddenPost, hiddenIdx) => (
                          <li class="series-item series-item--hidden" data-series-section="after" role="listitem">
                            <span class="series-badge" aria-hidden="true">{hiddenStart + hiddenIdx + 1}</span>
                            <div class="series-content">
                              <a href={`/blog/${hiddenPost.slug}`} class="series-title series-title--link">
                                {truncate(hiddenPost.data.title, 80)}
                              </a>
                            </div>
                          </li>
                        ))}
                      </>
                    );
                  }
                })()}
              </>
            )}
          </>
        );
      })}
    </ol>
  </nav>
</aside>

<script>
  (function () {
    document.addEventListener("click", function (e) {
      const btn = (e.target as HTMLElement).closest("[data-series-toggle]") as HTMLButtonElement;
      if (!btn) return;

      const section = btn.getAttribute("data-series-toggle");
      const list = btn.closest("[data-series-list]");
      if (!list) return;

      // Find all items in this section
      const selector = section ? `[data-series-section="${section}"]` : ".series-item--hidden";
      const hiddenItems = list.querySelectorAll(selector);

      // Toggle visibility
      const isExpanded = btn.getAttribute("aria-expanded") === "true";
      const newState = !isExpanded;

      hiddenItems.forEach(function (item) {
        if (newState) {
          item.classList.remove("series-item--hidden");
        } else {
          item.classList.add("series-item--hidden");
        }
      });

      btn.setAttribute("aria-expanded", newState ? "true" : "false");

      // Update button text
      const count = hiddenItems.length;
      const originalText = count + " more parts…";
      const collapsedText = "Show less";
      btn.textContent = newState ? collapsedText : originalText;
    });
  })();
</script>

---
import { getCollection } from "astro:content";
import { ENV } from "varlock/env";

interface Props {
  url: string;
}

const { url } = Astro.props;

let updatedUrl = new URL(url);
let title: string | undefined = undefined;

const pathParts = updatedUrl.pathname.split("/").filter(Boolean);
const [username, slug] = pathParts;

if (username === "nickytonline" || username === "opensauced") {
  updatedUrl = new URL(
    updatedUrl.pathname.replace(/\/(nickytonline|opensauced)/, "/blog"),
    Astro.url
  );

  // the blog slug here is in the blog content collection so get the title from there
  const blogSlug = updatedUrl.pathname.replace("/blog/", "").replace(/\/$/, "");
  title = await getCollection("blog").then((entries) => {
    const entry = entries.find((e) => e.slug === blogSlug);
    return entry?.data.title;
  });
} else if (username && slug) {
  try {
    const response = await fetch(
      `https://dev.to/api/articles/${username}/${slug}`,
      {
        headers: {
          "api-key": ENV.DEV_API_KEY,
        },
      }
    );

    if (response.ok) {
      const post = await response.json();
      title = post.title;
    }
  } catch (error) {
    console.error(`Failed to fetch dev.to article title for ${url}:`, error);
  }
}

const encodedUrl = encodeURIComponent(updatedUrl.toString()).replace(/\/$/, "");
---

<a href={updatedUrl} class="relative block w-fit" data-embed>
  <span class="sr-only">{title ?? updatedUrl}</span>
  <picture>
    <source
      type="image/webp"
      srcset={`https://v1.opengraph.11ty.dev/${encodedUrl}/small/webp/ 375w, https://v1.opengraph.11ty.dev/${encodedUrl}/medium/webp/ 650w`}
      sizes="100vw"
    />
    <source
      type="image/jpeg"
      srcset={`https://v1.opengraph.11ty.dev/${encodedUrl}/small/jpeg/ 375w, https://v1.opengraph.11ty.dev/${encodedUrl}/medium/jpeg/ 650w`}
      sizes="100vw"
    />
    <img
      alt={""}
      class="block"
      loading="lazy"
      decoding="async"
      src={`https://v1.opengraph.11ty.dev/${encodedUrl}/small/jpeg/`}
      width="650"
      height="341"
    />
  </picture>
  {
    title ? (
      <span class="absolute bottom-0 left-0 w-full px-2 py-1 text-sm bg-white/70 dark:bg-black/70 text-black dark:text-white">
        {title}
      </span>
    ) : null
  }
</a>

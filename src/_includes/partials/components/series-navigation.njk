{# Series Navigation Component
   Displays all posts in a series with current post highlighted
#}

{% if series %}
  {% set seriesPosts = collections.posts | seriesFilter(series) | sort(attribute='date') %}

  {% if seriesPosts.length > 1 %}
    {# Build a reliable array #}
    {% set seriesPostsArr = [] %}
    {% for p in seriesPosts %}
      {% set _ = seriesPostsArr.push(p) %}
    {% endfor %}

    {# Find current index #}
    {% set currentIndex = -1 %}
    {% for post in seriesPostsArr %}
      {% if post.url == page.url %}
        {% set currentIndex = loop.index0 %}
      {% endif %}
    {% endfor %}

    {% set totalPosts = seriesPostsArr.length %}
    {% set hasCollapse = totalPosts > 5 %}

    <aside class="series-navigation">
      <nav aria-label="Series navigation" role="navigation">
        <h2>{{ series | seriesName }}</h2>

        <ol
          id="series-list-{{ series | slug }}"
          class="series-list"
          role="list"
          data-series-list
        >
          {% if hasCollapse %}
            {# STRICT 5-ITEM LOGIC:
               Always show exactly 5 visible items (including ellipsis)
               Pattern depends on current position
            #}

            {# Determine position zones #}
            {% set isFirst = (currentIndex == 0) %}
            {% set isSecond = (currentIndex == 1) %}
            {% set isSecondToLast = (currentIndex == totalPosts - 2) %}
            {% set isLast = (currentIndex == totalPosts - 1) %}

            {% for post in seriesPostsArr %}
              {% set i = loop.index0 %}
              {% set isCurrent = (i == currentIndex) %}
              {% set shouldShow = false %}
              {% set showEllipsisBefore = false %}
              {% set showEllipsisAfter = false %}

              {# Position: First post (index 0) #}
              {% if isFirst %}
                {% if i == 0 or i == 1 or i == 2 or i == totalPosts - 1 %}
                  {% set shouldShow = true %}
                {% endif %}
                {% if i == 3 %}
                  {% set showEllipsisAfter = true %}
                {% endif %}

              {# Position: Second post (index 1) #}
              {% elif isSecond %}
                {% if i == 0 or i == 1 or i == 2 or i == totalPosts - 1 %}
                  {% set shouldShow = true %}
                {% endif %}
                {% if i == 3 %}
                  {% set showEllipsisAfter = true %}
                {% endif %}

              {# Position: Second to last (index n-2) #}
              {% elif isSecondToLast %}
                {% if i == 0 or i == totalPosts - 3 or i == totalPosts - 2 or i == totalPosts - 1 %}
                  {% set shouldShow = true %}
                {% endif %}
                {% if i == 1 %}
                  {% set showEllipsisBefore = true %}
                {% endif %}

              {# Position: Last post (index n-1) #}
              {% elif isLast %}
                {% if i == 0 or i == totalPosts - 3 or i == totalPosts - 2 or i == totalPosts - 1 %}
                  {% set shouldShow = true %}
                {% endif %}
                {% if i == 1 %}
                  {% set showEllipsisBefore = true %}
                {% endif %}

              {# Position: Middle (index 2 to n-3) #}
              {% else %}
                {% if i == 0 or i == currentIndex or i == totalPosts - 1 %}
                  {% set shouldShow = true %}
                {% endif %}
                {% if i == 1 %}
                  {% set showEllipsisBefore = true %}
                {% endif %}
                {% if i == currentIndex + 1 %}
                  {% set showEllipsisAfter = true %}
                {% endif %}
              {% endif %}

              {# Render the item if it should be shown #}
              {% if shouldShow %}
                <li class="series-item{% if isCurrent %} series-item--current{% endif %}" role="listitem">
                  <span class="series-badge{% if isCurrent %} series-badge--current{% endif %}" aria-hidden="true">{{ i + 1 }}</span>
                  <div class="series-content">
                    {% if isCurrent %}
                      <span class="series-title series-title--current">{{ post.data.title }}</span>
                      <span class="sr-only">(current post)</span>
                    {% else %}
                      <a href="{{ post.url }}" class="series-title series-title--link">{{ post.data.title | truncate(80) }}</a>
                    {% endif %}
                  </div>
                </li>
              {% endif %}

              {# Ellipsis before current (for middle/end positions) #}
              {% if showEllipsisBefore %}
                {% set hiddenCount = 0 %}
                {% if isSecondToLast or isLast %}
                  {% set hiddenCount = totalPosts - 4 %}
                {% else %}
                  {% set hiddenCount = currentIndex - 1 %}
                {% endif %}

                {% if hiddenCount == 1 %}
                  {# Just render the single hidden item #}
                  {% if isSecondToLast or isLast %}
                    {% set hiddenPost = seriesPostsArr[1] %}
                    <li class="series-item" role="listitem">
                      <span class="series-badge" aria-hidden="true">2</span>
                      <div class="series-content">
                        <a href="{{ hiddenPost.url }}" class="series-title series-title--link">{{ hiddenPost.data.title | truncate(80) }}</a>
                      </div>
                    </li>
                  {% else %}
                    {% set hiddenPost = seriesPostsArr[currentIndex - 1] %}
                    <li class="series-item" role="listitem">
                      <span class="series-badge" aria-hidden="true">{{ currentIndex }}</span>
                      <div class="series-content">
                        <a href="{{ hiddenPost.url }}" class="series-title series-title--link">{{ hiddenPost.data.title | truncate(80) }}</a>
                      </div>
                    </li>
                  {% endif %}
                {% else %}
                  <li class="series-item series-item--toggle" role="listitem">
                    <span class="series-badge series-badge--collapsed" aria-hidden="true">···</span>
                    <button type="button" class="series-toggle" aria-expanded="false" data-series-toggle="before">
                      {{ hiddenCount }} more parts…
                    </button>
                  </li>

                  {# Hidden items before current #}
                  {% if isSecondToLast or isLast %}
                    {% for hiddenPost in seriesPostsArr.slice(1, totalPosts - 3) %}
                      <li class="series-item series-item--hidden" data-series-section="before" role="listitem">
                        <span class="series-badge" aria-hidden="true">{{ loop.index + 1 }}</span>
                        <div class="series-content">
                          <a href="{{ hiddenPost.url }}" class="series-title series-title--link">{{ hiddenPost.data.title | truncate(80) }}</a>
                        </div>
                      </li>
                    {% endfor %}
                  {% else %}
                    {% for hiddenPost in seriesPostsArr.slice(1, currentIndex) %}
                      <li class="series-item series-item--hidden" data-series-section="before" role="listitem">
                        <span class="series-badge" aria-hidden="true">{{ loop.index + 1 }}</span>
                        <div class="series-content">
                          <a href="{{ hiddenPost.url }}" class="series-title series-title--link">{{ hiddenPost.data.title | truncate(80) }}</a>
                        </div>
                      </li>
                    {% endfor %}
                  {% endif %}
                {% endif %}
              {% endif %}

              {# Ellipsis after current (for start/middle positions) #}
              {% if showEllipsisAfter %}
                {% set hiddenCount = 0 %}
                {% if isFirst or isSecond %}
                  {% set hiddenCount = totalPosts - 4 %}
                {% else %}
                  {% set hiddenCount = totalPosts - currentIndex - 2 %}
                {% endif %}

                {% if hiddenCount == 1 %}
                  {# Just render the single hidden item #}
                  {% if isFirst or isSecond %}
                    {% set hiddenPost = seriesPostsArr[3] %}
                    <li class="series-item" role="listitem">
                      <span class="series-badge" aria-hidden="true">4</span>
                      <div class="series-content">
                        <a href="{{ hiddenPost.url }}" class="series-title series-title--link">{{ hiddenPost.data.title | truncate(80) }}</a>
                      </div>
                    </li>
                  {% else %}
                    {% set hiddenPost = seriesPostsArr[currentIndex + 1] %}
                    <li class="series-item" role="listitem">
                      <span class="series-badge" aria-hidden="true">{{ currentIndex + 2 }}</span>
                      <div class="series-content">
                        <a href="{{ hiddenPost.url }}" class="series-title series-title--link">{{ hiddenPost.data.title | truncate(80) }}</a>
                      </div>
                    </li>
                  {% endif %}
                {% else %}
                  <li class="series-item series-item--toggle" role="listitem">
                    <span class="series-badge series-badge--collapsed" aria-hidden="true">···</span>
                    <button type="button" class="series-toggle" aria-expanded="false" data-series-toggle="after">
                      {{ hiddenCount }} more parts…
                    </button>
                  </li>

                  {# Hidden items after current #}
                  {% if isFirst or isSecond %}
                    {% for hiddenPost in seriesPostsArr.slice(3, totalPosts - 1) %}
                      <li class="series-item series-item--hidden" data-series-section="after" role="listitem">
                        <span class="series-badge" aria-hidden="true">{{ loop.index + 3 }}</span>
                        <div class="series-content">
                          <a href="{{ hiddenPost.url }}" class="series-title series-title--link">{{ hiddenPost.data.title | truncate(80) }}</a>
                        </div>
                      </li>
                    {% endfor %}
                  {% else %}
                    {% for hiddenPost in seriesPostsArr.slice(currentIndex + 1, totalPosts - 1) %}
                      <li class="series-item series-item--hidden" data-series-section="after" role="listitem">
                        <span class="series-badge" aria-hidden="true">{{ loop.index + currentIndex + 1 }}</span>
                        <div class="series-content">
                          <a href="{{ hiddenPost.url }}" class="series-title series-title--link">{{ hiddenPost.data.title | truncate(80) }}</a>
                        </div>
                      </li>
                    {% endfor %}
                  {% endif %}
                {% endif %}
              {% endif %}

            {% endfor %}

          {% else %}
            {# 5 or fewer posts - show all #}
            {% for post in seriesPostsArr %}
              {% set i = loop.index0 %}
              {% set isCurrent = (post.url == page.url) %}
              <li class="series-item{% if isCurrent %} series-item--current{% endif %}" role="listitem">
                <span class="series-badge{% if isCurrent %} series-badge--current{% endif %}" aria-hidden="true">
                  {{ i + 1 }}
                </span>
                <div class="series-content">
                  {% if isCurrent %}
                    <span class="series-title series-title--current">{{ post.data.title }}</span>
                    <span class="sr-only">(current post)</span>
                  {% else %}
                    <a href="{{ post.url }}" class="series-title series-title--link">
                      {{ post.data.title | truncate(80) }}
                    </a>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          {% endif %}
        </ol>
      </nav>
    </aside>

    <script>
      (function () {
        document.addEventListener("click", function (e) {
          var btn = e.target.closest("[data-series-toggle]");
          if (!btn) return;

          var section = btn.getAttribute("data-series-toggle");
          var list = btn.closest("[data-series-list]");
          if (!list) return;

          // Find all items in this section
          var selector = section ? '[data-series-section="' + section + '"]' : ".series-item--hidden";
          var hiddenItems = list.querySelectorAll(selector);

          // Toggle visibility
          var isExpanded = btn.getAttribute("aria-expanded") === "true";
          var newState = !isExpanded;

          hiddenItems.forEach(function (item) {
            if (newState) {
              item.classList.remove("series-item--hidden");
            } else {
              item.classList.add("series-item--hidden");
            }
          });

          btn.setAttribute("aria-expanded", newState ? "true" : "false");

          // Update button text
          var count = hiddenItems.length;
          var originalText = count + " more parts…";
          var collapsedText = "Show less";
          btn.textContent = newState ? collapsedText : originalText;
        });
      })();
    </script>

  {% endif %}
{% endif %}

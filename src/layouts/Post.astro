---
import MainLayout from "./MainLayout.astro";
import PostIntro from "../components/PostIntro.astro";
import SeriesNavigation from "../components/SeriesNavigation.tsx";
import type { CollectionEntry } from "astro:content";
import site from "../data/site";
import { seriesFilter } from "../utils/filters";
import { getCollection } from "astro:content";
import Tag from "@/components/Tag.astro";

export interface Props {
  entry: CollectionEntry<"blog">;
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const currentUrl = `/blog/${entry.slug}`;

// Get series posts if this is part of a series
let seriesPosts: CollectionEntry<"blog">[] = [];
if (entry.data.series) {
  const allPosts = await getCollection("blog");
  seriesPosts = seriesFilter(
    allPosts,
    entry.data.series
  ) as CollectionEntry<"blog">[];
}
---

<MainLayout
  title={entry.data.title}
  metaDesc={entry.data.excerpt || entry.data.description}
  socialImage={new URL(entry.data.cover_image!, site.url).toString()}
>
  <article>
    <PostIntro
      title={entry.data.title}
      cover_image={entry.data.cover_image}
      date={entry.data.date}
      reading_time_minutes={entry.data.reading_time_minutes}
      fileSlug={entry.slug}
      url={currentUrl}
      canonical_url={entry.data.canonical_url}
    />

    {
      entry.data.series && seriesPosts.length > 1 && (
        <div>
          <SeriesNavigation
            client:load
            series={entry.data.series}
            currentUrl={currentUrl}
            posts={seriesPosts}
          />
        </div>
      )
    }

    <div class="prose prose-lg max-w-none">
      <Content />
    </div>

    {
      entry.data.tags && entry.data.tags.length > 0 && (
        <footer class="pt-8">
          <div class="flex items-center gap-3 flex-wrap">
            <h2 class="text-foreground">Tags:</h2>
            <ul class="flex flex-wrap gap-2">
              {entry.data.tags.map((tag) => (
                <li>
                  <Tag tag={tag} />
                </li>
              ))}
            </ul>
          </div>
        </footer>
      )
    }
  </article>
</MainLayout>
